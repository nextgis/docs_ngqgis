.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _ngqgis_editing:

Редактирование
==============

Работа с таблицей атрибутов
-----------------------------

У векторных слоёв имеются атрибуты, которые описывают свойства объектов слоя. Их используют 
для настройки отображения данных. Атрибуты векторных объектов хранятся в таблице. Для того, чтобы просмотреть её, выделите нужный слой, затем в главной панели в меню **Слой** выберите **Таблица атрибутов**.

.. figure:: _static/UIAttributeTable_open_ru.png
   :name: ngqgis_UIAttributeTable1
   :align: center
   :width: 20cm

   Открытие таблицы атрибутов

Второй вариант - в контекстном меню слоя выберите **Открыть таблицу атрибутов**.

.. figure:: _static/UIAttributeTable_ru.png
   :name: ngqgis_UIAttributeTable_pic
   :align: center
   :width: 16cm
   
   Таблица атрибутов к выбранному слою



Каждый столбец таблицы атрибутов называется полем, каждая строка — записью. Каждая запись таблицы 
атрибутов соответствует одному объекту в векторном слое. Столбцы - это атрибуты слоя. 
Aтрибутивные записи объекта слоя связаны с геометрией объекта. Геометрия объекта 
отображается на карте. 

Таблицу атрибутов может также демонстрироваться в виде формы, тогда слева будет список всех объектов слоя, а справа - атрибуты выбранного объекта.

.. figure:: _static/UIAttributeTable_form_ru.png
   :name: ngqgis_UIAttributeTable_form_pic
   :align: center
   :width: 16cm
   
   Таблица атрибутов в виде формы

Можно настроить, чтобы таблица атрибутов открывалась в отдельном окне, а можно - 
чтобы она всегда была внутри основного окна программы. Для этого в меню "Параметры" нужно выбрать вкладку "Источники данных" и установить флажок **Открывать таблицу атрибутов в закрепленном окне**.

.. figure:: _static/UIAttributeTable_settings_ru.png
   :name: ngqgis_UIAttributeTable3
   :align: center
   :width: 20cm

   Настройка таблицы атрибутов


Можно настроить, чтобы объекты из одного слоя, но с разными атрибутами отображались 
с разным оформлением. См. :ref:`ngq_vector_styles`.


В таблице атрибутов чаще всего используются следующие кнопки:

1. Сортировка по полю.

.. figure:: _static/UIAttributeTable_buttons_ru.png
   :name: ngqgis_UIAttributeTable4
   :align: center
   :width: 20cm

   Кнопки в таблице атрибутов. Стрелкой показана сортировка по полю

2. Включить режим редактирования слоя. Теперь в слое можно править значения как в электронной таблице, так и править геометрию.
3. Сохранить правки в этом слое (отдельно от сохранения всего проекта). 
4. Удалить выделенные обьекты.
5. |button_deselect| Снять выделение с объектов. 
6. |button_pan_map| Переместить карту на выделеный объект или несколько объектов.
7. |button_zoom| Изменить масштаб карты на выделенный объект или несколько выделенных объектов.
8. Копировать-вставить выделенные объекты (вместе с геометрией). 
9. Удалить или добавить атрибут (столбец).
10. |button_calculator| Запуск калькулятора полей. Добавляется новый столбец со значениями по формулам, как в Excel.

.. |button_deselect| image:: _static/button_deselect.png

.. |button_pan_map| image:: _static/button_pan_map.png

.. |button_zoom| image:: _static/button_zoom.png

.. |button_calculator| image:: _static/button_calculator.png


.. figure:: _static/UIAttributeTableSearch.png
   :name: ngqgis_UIAttributeTableSearch
   :align: center
   :width: 15cm

   Пример использования выражения для поиска обьектов в слое по значениям.
   
   Цифрами обозначено: 1. Кнопка выбора меню. 2. Поле ввода имени.   

.. _ngqgis_editing_identify:

Идентификация
--------------------

В :program:`NextGIS QGIS` есть возможность, нажимая на объекты векторных слоёв на карте мышью,
просматривать их атрибуты. Это называется "Идентификация".

.. figure:: _static/UIIdentify.png
   :name: ngqgis_UIIdentify
   :align: center
   :width: 16cm
   
   Работа инструмента идентификации.
   
   Выберите инструмент идентификации (1). 
   Щёлкните на каком-нибудь объекте на карте (2). На экран выведутся его атритуты (3). 
   В панели инструментов "Результат определения" (4) можно настроить, что именно 
   будет показываться на экране при нажатии: будет ли открываться отдельное окно 
   или нет.
   

.. note::
   При идентификации, если включён режим "Открывать форму", то при нажатии на несколько 
   объектов по очереди, выделение может не сниматься. Это не является ошибкой: где-то 
   на дисплее остаются открытые окна идентификации, поэтому они и остаются красными. 


Выбор объектов
------------------------------------

Выделять объекты можно многими способами.

* Выбирать в таблице атрибутов. Там можно быстро отсортировать объекты по полю, и выделить только нужные объекты
* Выбирать мышкой на карте.
* Выбирать выражением QGIS. В выражениях доступны так же переменные расчитываемые QGIS, такие как площадь в квадратных метрах.
* Фильтровать на стороне провайдера выражением. Провайдер данных выполнит написаный вами SQL-запрос по атрибутам, и вернёт только соответствующие объекты. Это намного быстрее чем фильтровать выражением, но сложнее работать с геометрией. 
* Выбирать пространственным запросом через плагин. Используется если нужно выделить объекты в одном слое, пересекающиеся с другим слоем.

Выделение объектов в таблице атрибутов
-----------------------------------------
   

.. figure:: _static/UISelect.png
   :name: ngqgis_UISelect
   :align: center
   :width: 20cm
   
   Выделение нескольких объектов.  В таблице атрибутов - режим "Выделенные объекты".
   
   Цифрами обозначено: 1. Кнопка панели инструментов для выделения объектов 2. Выделенные объекты. 
   3. Кнопка выбора режима Выделенные объекты. 4. Выделенные объекты в таблице атрибутов.
   
Рядом есть жёлтая иконка - выделения объектов (1). Она выделяет объекты в том слое, 
который выбран в меню слоёв. Выделенные объекты подсвечиваются в таблице атрибутов, 
их можно скопировать или удалить. 


Выделение объектов на карте
------------------------------------

   

.. figure:: _static/UISelectButtons.png
   :name: ngqgis_UISelectButtons
   :align: center

   
   
Для выделения векторных объектов выберите слой, и нажмите кнопку "Выделить объекты по площади или щелчком мыши". Выделять объекты можно по клику или обводя область рамкой. Может быть выделено несколько 
объектов по очереди с нажатой клавишей ``Ctrl``. Правее имеется кнопка "Снять выделение".

Можно выделять объекты на карте полигоном, карандашом, или кругом.

Рядом есть кнопка с меню, в котором есть кнопки "Выбор по выражению", "Выбрать все объекты" и "Обратить выделение".

Выделение объектов по выражению
-------------------------------------

Пространственный запрос
-------------------------------------

Пространственный запрос делается плагином "Пространственный запрос". Этот плагин предустановлен, но не включён, его нужно включить в настройках. 
Его возможности:

*  выделить объекты которые касаются с объектами другого слоя
*  выделить объекты которые находятся внутри объектов другого слоя
*  выделить объекты которые пересекаются с объектами другого слоя
*  выделить объекты которые не пересекаются с объектами другого слоя
*  выделить объекты которые совпадают с объектами другого слоя
*  выделить объекты которые содержат с объектами другого слоя

* Копировать  выделенные объекты в временный слой.


или не пересекаются с другим слоем.

Фильтры (отбор значений)
------------------------------------

Имеется два способа отфильтровать таблицу по значениям. 

1. Контекстное меню слоя ‣ Фильтр.
2. Таблица атрибутов слоя ‣ Кнопка "Фильтр" ‣ Выражение. 


.. figure:: _static/UIFilterOpen.png
   :name: ngqgis_filter_open
   :align: center
   :width: 16cm
   
   Вызов окна фильтра.

На экран выведется диалоговое окно, в которое нужно будет ввести выражение. Те записи, 
для которых это выражение будет истинно, будут показываться в таблице, остальные - 
скроются из таблицы, но останутся в файле.

Примеры выражений:

.. code-block:: sql

   "leaf_length" < 10
   "temp" > 5 AND "temp" < 10

Операции, запускаемые через меню "Вектор", будут выполняться только для тех записей, 
которые отображаются в таблице.

Эти два способа фильтрации работают на разном уровне. 
Первый вариант выполняется библиотекой GDAL на уровне провайдера. Он не видит виртуальных 
полей и недоступен для некоторых типов данных, например :term:`CSV`. При работе с :term:`WFS`, :term:`PostGIS`, 
:term:`ESRI Shapefile` и другими базами данных он должен выполняться быстрее.
Второй вариант выполняется на уровне NextGIS QGIS. Он видит виртуальные поля, и ему доступны 
все функции, которые видны в калькуляторе полей. Например можно выводить на экран 
только водоёмы с площадью больше определённого предела. 

Диалект SQL используемый в первом способе описан в документации GDAL: http://www.gdal.org/ogr_sql.html

В добавление к арифметическим и другим функциям, в фильтре слоя доступны логические операторы. Это  =, !=, <>, <, >, <=, >=, LIKE и ILIKE, BETWEEN и IN. != то же самое что <>, сравнение строк регистронезависимо, операторы <, >, <= , >=, LIKE, ILIKE  зависят от регистра.

Оператор LIKE принимает строку - шаблон, с которым сравнивается атрибут. Символ % обозначает совпадение с любым количеством символов, символ _ обозначает совпедение с одним символом.

.. code-block:: sql

   "NAME" LIKE 'Москов%'
   
Оператор IN принимает список значений, и выдаёт True, если атрибут совпадает с одним из участников списка.

.. code-block:: sql

   "HIGHWAY" IN ('primary','secondary')

Оператор BETWEEN выдаёт True, если атрибут находится между двумя значениями. Его синтаксис "field_name BETWEEN value1 AND value2" эквивалентен "field_name >= value1 AND field_name <= value2".

Оператор IS NULL выдаёт True, если атрибут пустой, IS NOT NULL выдаёт True, если атрибут не пустой.

При выполнении фильтра в таблице, генерируется запрос такого вида: "guid" ILIKE '{59BB1DC1-D72E-4CF5-9162-5194EEAB1958}', то есть в строку поиска нужно вставлять искомую строку "как есть", без кавычек.

Построение выражений
-----------------------------------

Выражения в QGIS - мощный способ для 

* изменения значений атрибутов
* изменения геометрий
* динамического изменения стилей
* динамического изменения текстов, положения, цветов и оформления подписей
* выборки, фильтрации, удаления объектов
* создания и расчёта значений полей

Эти операции можно выполнять как с записью данных на диск, так и с вычислением каждый раз "на лету".

Ввод выражений происходит в диалоге "Построитель выражения". Он запускается из разных частей QGIS:

* Кнопка ε
* Инструмент "Выбрать по выражению"
* Калькулятор полей
* Переопределение значений в диалогах настройки стиля
* Генератор геометрии
* Некоторые инструменты анализа данных.

Язык выражений в калькуляторе полей QGIS
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

"FIELDNAME" - названия других полей записываются в двойных кавычках

'улица' - строковые константы записываются в одинарных кавычках

Для составления выражения в списке вам доступны функции, другие поля этого же объекта, и системные константы (со знаком $)

Список некоторых часто используемых функций. Полный список привести в документации невозможно, если вы хотите ознакомиться подробнее - прочтите описания всех функций в окне калькулятора полей. Часто оказывается что одну задачу можно сделать несколькими способами. Например, если вам нужно получить площадь буфера вокруг каждой точки - можно расчитать её в калькуляторе полей, а можно сгенерировать новый слой с буфером, и расчитать площадь его объектов. 

Преобразования

* to_int, to_string, to_real, to_date, to_datetime, to_time - конвертирует значение в конкретный тип данных. Некоторые функции QGIS требуют полей заданного типа, например раскраска по значениям работает только с числами, не со строками.
* to_decimal, to_dms - конвертирует координаты из градусов-минут-секунд в десятичные градусы и обратно: to_decimal('6°21'16.445') → 6.3545680555, 
to_dms(6.1545681, 'x', 3) → 6°9′16.445″

Условные операторы

* if(condition,result_when_true,result_when_false) - Проверяет условие и возвращает результат в зависимости от результата проверки.
* CASE - Возвращает результат одного из нескольких условий
* coalesce - Принимает несколько условий, возвращает первое из них которое IS NOT NULL.
* nullif - Заменяет конкретное значение на NULL (эквивалентно Replace)

Геометрия

* $geometry - возвращает геометрию текущего объекта
* geometry(feature) - возвращает геометрию объекта по id
* $area, $lenght, $perimeter - возвращает измерения текущего объекта с учётом настроек эллипсоида и единиц измерения в проекте
* area($geometry), lenght($geometry), perimeter($geometry) - измерения текущего объекта в единицах измерения его слоя
* geom_to_wkb($geometry), geom_to_wkt($geometry), x(geometry), y(geometry) - конвертация геометрии в строковое представление, получение числовых координат одной точки
* point_n(geometry,index) - возвращает геометрию точки из линии/полигона по номеру



Подсчёт длин и площадей геометрии
------------------------------------

Калькулятор полей
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


.. figure:: _static/field_calculator.png
   :name: field_calculator
   :align: center
   :width: 10cm
 
   Калькулятор полей  

Этот инструмент добавляет к векторному слою новый атрибут, и заполняет его значениями расчитаными по формуле. Запускайте калькулятор полей из таблицы атрибутов слоя.
В окне задайте название добавляемого атрибута, его тип данных, и формулу. Просмотрите список функций - при нажатии по ним открывается описание.

Определение площади фигуры в квадратных километрах
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для вычисления площади фигуры в квадратных километрах необходимо выполнить ряд шагов:


.. figure:: _static/elipsoids.png
   :name: elipsoids
   :align: center
   :width: 10cm
 
   Настройка эллипсоида  

1. В свойствах проекта включить `Преобразование координат на лету (OTF)``
2. В свойствах проекта "Общие" выставить "Эллипсоид для вычислений" в значение WGS 84, 
   в поле ``единицы для измерения длин`` указать метры, ``единицы для измерения площадей`` - 
   квадратные километры (см. :ref:`project_settings`).
3. Инструментом идентификации щёлкнуть на площадной объект. В открывшемся диалоге "Результат определения" 
   в дереве атрибутов раскрыть пункт "Выведенные". Там будет указана площадь в квадратных километрах, 
   подсчитанная на эллипсоиде WGS 1984.
   
 
Расчёт площади фигуры в квадратных метрах 
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Эта операция добавляет в слой атрибут с расчитаной площадью
  
1. В свойствах проекта включить `Преобразование координат на лету (OTF)``
2. В свойствах проекта "Общие" выставить "Эллипсоид для вычислений" в значение WGS 84, 
   в поле ``единицы для измерения длин`` указать метры, ``единицы для измерения площадей`` - 
   квадратные километры (см. :ref:`project_settings`).   
3. Выделить слой, зайти в калькулятор полей, создать новое поле ``square``, тип ``real``, размер ``20``, точность ``10``. 
4. Ввести выражение для расчета:
   
   * Выражение для квадратных метров: $area.
   * Выражение для квадратных километров: $area / 1000000.
   * Выражение для целого значения гектаров: round( $area / 10000 ).

.. figure:: _static/field_calculator_square.png
   :name: field_calculator_square
   :align: center
   :width: 10cm
 
   Создание поля с площадью в гектарах через калькулятор полей.  

5. После завершения работы калькулятора полей в таблице атрибутов будет видна площадь. 

Можно создать виртуальное поле - тогда в NextGIS QGIS при создании новой геометрии значение этого поля будет считаться на лету. 

.. note:: 
   В настройках подписей можно генерировать подпись выражением на лету, 
   однако в NextGIS QGIS 17.12 площади считаются только в единицах измерения слоя, а не проекта. 
 
Если правильная площадь не получилась, то используйте следующий метод. Он более низкоуровневый.

Расчёт площади фигуры в других единицах измерения через UTM
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Эта операция добавляет в слой атрибут с расчитаной площадью

1. Определить зону UTM. Для Московской области это 37N. Вы можете воспользоваться веб-картой: http://datahub.nextgis.com/resource/51/display
2. Сохранить слой в ESRI Shapefile или GeoJSON в систему координат, которая называется "WGS 84 / UTM {ваша зона}". Для Московской области - выберите WGS 84 / UTM 37N. Далее - так же как в прошлом методе, только используйте фунции без знака $
3. Выделить слой, зайти в калькулятор полей, создать новое поле ``square``, тип ``real``, размер ``20``, точность ``10``. 
4. Ввести выражение для расчета:
   
   * Выражение для квадратных метров: area.
   * Выражение для квадратных километров: area / 1000000.
   * Выражение для целого значения гектаров: round( area / 10000 ).

.. figure:: _static/field_calculator_square.png
   :name: field_calculator_square
   :align: center
   :width: 10cm
 
   Создание поля с площадью в гектарах через калькулятор полей.  

Функция $area возвращает площадь с учётом элипсоида и единиц измерения выбранных в настройках проекта, а area - возвращает площадь в единицах измерения слоя, то есть если слой в EPSG:4326, то получится площадь в квадратных градусах, а в EPSG:32637 - в настоящих метрах, а в EPSG:3857 - тоже в метрах, но не совпадающих с настоящими.

5. После завершения работы калькулятора полей в таблице атрибутов будет видна площадь. 

Редактирование геометрий
--------------------------

Для того что бы редактировать геометрии или создавать новые, необходимо иметь векторный слой. 
О создании векторного слоя см. подраздел :ref:`ngq_create_new_layer`. 

Редактирование геометрий так же может называться оцифровкой. Все возможности редактирования 
векторных слоев разделены между панелями:

1. Панель инструментов "Оцифровка". 
2. Панель инструментов "Дополнительные функции оцифровки".

Для рисования включите панель инструментов "Оцифровка". См. подраздел :ref:`ngq_label_toolbars` про включение панелей.

.. figure:: _static/drawing_tools.png
   :name: ngqgis_drawing_tools
   :align: center
   :width: 10cm
 
   Панель инструментов "Оцифровка".   
 
.. todo::
   Поставить гиперссылку на раздел про включение панели.


По умолчанию, NextGIS QGIS подгружает слои, делая их доступными только для чтения. 
Это защита от непреднамеренного редактирования слоя, что случается, например, при 
неловком движении манипулятором мышь. Любой слой можно переключить в режим редактирования 
(если источник данных поддерживает запись, и есть разрешение на запись).
При выходе из режима редактирования правки сохраняются в файл слоя или в базу данных. 
Для начала редактирования выделите слой в списке слоёв и нажмите кнопку с карандашом на 
панели редактирования. Любое редактирование начинается с выбора функции "Режим редактирования". 

Для того, чтобы начать или закончить редактирование также можно использовать кнопку 
"Режим редактирования" на панели инструментов "Оцифровка". После того, как слой стал 
доступным для редактирования, над каждой вершиной появятся специальные маркеры и 
станут доступными к использованию кнопки с дополнительными функциями из панели инструментов.

.. note::
   **Регулярное сохранение**
   
   Не забывайте нажимать Сохранить изменения регулярно. Это позволит 
   не только сохранить последние изменения, но и удостовериться, что источники 
   данных могут принять все сделанные изменения.

Добавление объектов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
Для добавления объектов можно использовать кнопки на панели инструментов: 

* Создать точку, 
* Создать линию, 
* Создать полигон, 

чтобы переключить NextGIS QGIS в режим редактирования.

Для каждого объекта сначала идет оцифровка формы, а затем добавляются атрибуты. 
Чтобы начать оцифровку и создать первую точку нового объекта, надо нажать левой 
кнопкой мыши в области карты.

Для продолжения линий и полигонов надо продолжать нажимать на левую кнопку мыши 
для создания каждого дополнительного узла. Чтобы закончить редактирование объекта, 
щелкните правой кнопки мыши в любом месте карты, что подтвердит окончание
редактирования данного объекта. При этом, появится окно атрибутов для ввода 
информации для нового объекта. Во вкладке "Оцифровка" из меню ``Установки ‣ Параметры`` можно 
также активировать функцию "Не показывать всплывающее окно ввода атрибутов для каждого 
создаваемого объекта Использовать последние введённые значения".

С помощью опции ``Переместить объект`` на панели инструментов можно 
двигать созданные объекты.

**Типы значений атрибутов**

При редактировании :term:`ESRI Shapefile` типы атрибутов проверяются во время ввода. Поэтому 
невозможно ввести числовое значение в текстовое поле диалога "Атрибуты" или наоборот. 
Если это сделать все же необходимо, то следует отредактировать атрибуты на следующем 
шаге в диалоге "Таблица атрибутов".

Как для слоев данных :term:`PostGIS`, так и для слоев, состоящих из ESRI Shapefile, 
``Редактирование узлов`` предоставляет возможности изменения узлов объектов, 
аналогичные имеющимся в программах :abbr:`CAD (Computer-Aided Design)`. 
Можно выделить сразу множество вершин и 
перемещать, добавлять или удалять их все вместе. Инструмент редактирования узлов 
работает с включенной функцией перепроецирования "на лету", а также поддерживает 
топологическое редактирование объектов. Этот инструмент, в отличие от остальных 
инструментов NextGIS QGIS, довольно "настойчивый": так, когда некоторая операция 
выполнена, инструмент продолжает оставаться активным, а объект выделенным. Если 
инструмент редактирования узлов не может обнаружить объекты, на дисплей выдается 
предупреждение.

.. note::
   Если включено перепроецирование "на лету", и система координат карты отличается от
   системы координат слоя, то функции прилипания могут работать неккоректно из-за отличия
   в величине "близости" для различных систем координат. 

Важно правильно установить ``Установки ‣ Параметры ‣ Оцифровка ‣ Радиус поиска selectnumber``, 
значение должно быть больше нуля. В противном случае NextGIS QGIS не распознает редактируемую вершину.

**Маркеры вершин**

Данная версия NextGIS QGIS поддерживает три типа маркировки вершин:

1. Полупрозрачный круг. 
2. Перекрестие. 
3. Без маркера. 

Чтобы изменить стиль маркировки, выберите "Параметры" из меню "Установки" 
и на вкладке "Оцифровка" и далее выберите подходящий тип маркировки вершины.

**Основные операции**

Включите инструмент "Редактирование узлов" и выделите объект простым 
нажатием на него. На месте каждой вершины этого объекта появятся красные рамки.

**Выделение вершин**

Выделение узла происходит простым нажатием по нему кнопкой мыши, при этом цвет рамки 
изменится на синий. Чтобы выделить несколько узлов одновременно, надо удерживать 
клавишу ``Shift``. Нажатие на ``Ctrl`` используется для инвертирования выделения узлов 
(выделенные узлы становятся невыделенными и наоборот). Также несколько узлов одновременно 
можно выделить, если нажать кнопкой мыши где-нибудь в стороне от объекта и очертить 
прямоугольную область вокруг интересующего множества вершин. Или просто нажать на 
отрезок линии и оба смежных узла будут выделены.

**Добавление узлов**

Добавить узлы также просто. Двойной щелчок мыши рядом с отрезком линии добавит 
новую вершину рядом с положением курсора. 

.. note:: 
   Обратите внимание, что вершина появится 
   на ребре объекта, а не точно в месте курсора, но при необходимости ее можно переместить.

**Удаление узлов**

После выделения вершин для их удаления надо нажать клавишу ``Delete``, вершины будут 
удалены. 

.. note::
   Обратите внимание, что, согласно стандарту NextGIS QGIS, необходимое количество 
   узлов для каждого типа объекта все же останется. Чтобы полностью удалить объект, 
   надо использовать другой инструмент, а именно "Удалить выделенное".

**Перемещение узлов**

Выделите все вершины, которые собираетесь перемещать. Все выделенные вершины будут 
перенесены в направлении курсора. Если активна функция прилипания, все вершины могут 
перескочить на ближайшие узлы или линии.

При отпускании кнопки мыши все изменения будут сохранены и появятся в диалоге отмены. 
Запомните, что все операции поддерживают топологическое редактирование, когда оно 
включено. Перепроецирование "на лету" также поддерживается. Кроме того, инструмент 
редактирования показывает всплывающие подсказки при наведении указателя мыши на узел.

.. todo::
   Поставить гиперссылку на раздел про ввод координат с клавиатуры.

Сохранение отредактированных слоев
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Когда слой находится в режиме редактирования, любые изменения сохраняются только 
в памяти NextGIS QGIS. Изменения не сохраняются непосредственно на диск. Если необходимо 
сохранить изменения в текущем слое и при этом продолжать его редактирование, то 
нужно нажать на кнопку "Сохранить изменения". Если выключить режим 
редактирования, нажав на "Режим редактирования" (или просто 
выйти из NextGIS QGIS), то появится запрос программы, на сохранение изменений.

Если изменения не могут быть сохранены (например, диск полон или атрибуты имеют 
неверное значение), NextGIS QGIS сохранит их в своей памяти. Это позволит откорректировать 
изменения и попробовать еще раз сохранить изменения на диск.

.. tip::
   Целостность данных. Создание резервной копии данных перед началом редактирования — 
   это всегда хорошая идея. Несмотря на то, что авторы NextGIS QGIS сделали все 
   возможное для сохранения ваших данных, они по-прежнему не дают никаких гарантий 
   в этом отношении.

.. todo::
   Дополнительные функции оцифровки

Дополнительные возможности редактирования векторного слоя:

1. Отменить:

.. figure:: _static/drawing_tools_btn_undo.png
   
2. Вернуть:

.. figure:: _static/drawing_tools_btn_redo.png

Инструменты ``Отменить`` и ``Вернуть`` позволяют отменить либо вернуть 
последний или какой-либо конкретный шаг при редактировании векторных данных. При этом 
состояние всех объектов и их атрибутов возвращается на шаг назад. 

3. Повернуть объект:

.. figure:: _static/drawing_tools_btn_rotate.png

Выделите объект и нажмите кнопку поворота. Объект можно будет вращать мышью. После 
вращения его геометрия пересчитается с учётом искажения проекции. Можно вращать группу объектов.
С нажатой клавишей ``Ctrl`` можно перетащить точку центра поворота (отображается красным плюсом).

4. Упростить объект:

.. figure:: _static/drawing_tools_btn_simplify.png

Инструмент ``Упростить объект`` позволяет уменьшить количество вершин объекта, при этом, 
геометрия объекта не изменяется. Необходимо выделить объект, после чего он будет 
подсвечен красным и появится окно. При движении значений красная опоясывающая 
линия меняет свою форму, показывая тем самым, как именно объект будет упрощен. Если 
нажать кнопку "OK", новая упрощенная геометрия будет сохранена. Если объект не может 
быть упрощен (например, мультиполигоны), появится всплывающее окно предупреждения.

5. Добавить кольцо:

.. figure:: _static/drawing_tools_btn_addring.png

Можно создать кольцевой полигон (с дыркой посредине), используя функцию Добавить кольцо на панели инструментов. 
Внутри существующего полигона можно оцифровать последующий полигон, который превратиться 
в "отверстие", таким образом, только оставшаяся область между границами внешнего и
внутреннего полигона и будет кольцевым полигоном.

6. Добавить часть:

.. figure:: _static/drawing_tools_btn_addpart.png

Можно использовать "Добавить часть" для добавления новых полигонов к мультиполигональным
объектам. Новая полигональная часть должна быть создана за границами мультиполигона.

7. Заполнить кольцо

Нарисуйте полигон над уже существующим полигоном. Появится новый объект, а в существующем полигоне на его месте будет дырка.

8. Удалить кольцо:

.. figure:: _static/drawing_tools_btn_DeleteRing.png

Инструмент "Удалить кольцо" удаляет дырки внутри полигона. Им нужно нажимать на дырку.
Этот инструмент работает только с полигональными слоями. Никакик изменений 
не произойдет, если инструмент применяется на внешнем контуре полигона. Инструмент 
может применяться как для полигональных объектов, так и на мультиполигональных. 
Перед тем, как выделить вершины кольца, настройте порог прилипания для вершин.

9. Удалить часть:

.. figure:: _static/drawing_tools_btn_DeletePart.png

Инструмент "Удалить часть" позволяет удалять части мультиполигональных объектов (например, 
удалить полигон мультиполигонального объекта). Инструмент не сможет удалить последнюю
часть объекта. Она останется нетронутой. Инструмент работает со всеми типами геометрии: 
точками, линиями, полигонами. Перед тем, как выделить вершины части, необходимо 
настроить порог прилипания для вершин.

10. Корректировать форму:

.. figure:: _static/drawing_tools_btn_Reshape.png

Инструмент работает для линий и полигонов. Им рисуется ломаная линия, в конце нужно 
нажать правую кнопку мыши. Если начать линию снаружи полигона, провести её внутри полигона, 
и закончить за границей, то из полигона вырежется и удалится кусок. Если начать линию 
изнутри полигона, вывести за границу и закончить внутри полигона, то у полигона появится вырост.


.. figure:: _static/drawing_tools_btn_ReshapeDraw1.png

   Линия проведена снаружи полигона.

.. figure:: _static/drawing_tools_btn_ReshapeDraw2.png

   Из полигона вырезается кусок.

.. figure:: _static/drawing_tools_btn_ReshapeDraw3.png

   Линия проведена изнутри полигона.

.. figure:: _static/drawing_tools_btn_ReshapeDraw4.png

   К полигону добавляется вырост.
   
.. figure:: _static/drawing_tools_btn_ReshapeDraw5.png

   Инструмент корректирования формы применяется к линии.

.. figure:: _static/drawing_tools_btn_ReshapeDraw6.png

   Изменена форма линии.
   

Редактирование нескольких полигональных объектов одновременно невозможно, 
так как при этом будут создаваться полигоны с ошибочной геометрией.

.. note::
   Инструмент корректировки объектов может изменять начало кольца полигона или
   замкнутой линии. Так, точка, представленная "дважды", больше не будет таковой. Это 
   не должно быть проблемой при использовании большинства приложений, но, тем не менее, 
   это необходимо иметь в виду.

11. Параллельная кривая.

.. figure:: _static/drawing_tools_btn_OffsetCurve.png

Инструмент "Параллельная кривая" предназначен для параллельного переноса линий и колец 
полигона. Инструмент может применяться к редактируемому слою (в этом случае изменяются 
объекты) или же к фоновым слоям (в этом случае создаются копии линий/колец и добавляются 
в редактируемый слой). Таким образом, он идеально подходит для создания линейных 
слоёв с фиксированным шагом. 
Размер смещения отображается в нижней левой части строки состояния.

12. Разбить объекты.

.. figure:: _static/drawing_tools_btn_splitFeatures.png

 Инструмент "Разбить части" разрезает объект 
на фичи.  Получается два объекта с одинаковыми атрибутами.


.. figure:: _static/drawing_tools_btn_plitFeatures1.png

   Исходный объект

.. figure:: _static/drawing_tools_btn_plitFeatures2.png

   Разрезаный объект, получаются две фичи с одинаковыми атрибутами.
 
13. Разбить части.

.. figure:: _static/drawing_tools_btn_splitParts.png

   Инструмент "Разбить части" работает только для слоёв с мультигеометриями, разрезает объект 
на части. Получается один мультиполигональный объект из двух частей.


.. figure:: _static/drawing_tools_btn_splitParts1.png

   Исходный объект

.. figure:: _static/drawing_tools_btn_splitParts2.png

   Разрезаный объект, в таблице атрибутов видно, что объект остаётся один.
 

14. Объединить выбраные объекты.

.. figure:: _static/drawing_tools_btn_mergeFeatures.png

Этот инструмент позволяет объединять объекты, которые имеют общие границы и атрибуты.

15. Объединить атрибуты выбранных объектов.

Этот инструмент позволяет объединять атрибуты нескольких объектов без их объединения 
в один объект.

.. figure:: _static/drawing_tools_btn_mergeAtributes.png


.. todo::
   Картинки про рисование


Прилипание
--------------

.. figure:: _static/snapping_map.png
   :name: ngqgis_snapping_map
   :align: center
   :width: 16cm
 
   Оцифровка с включёным прилипанием, фиолетовый курсор показывает что линия прилипает.

Порог прилипания — это расстояние, используемое NextGIS QGIS, для поиска ближайшего 
узла и/или сегмента, к которому надо присоединиться при создании нового узла или 
передвижении уже существующего. Если превысить порог прилипания, то при нажатии 
кнопки мыши узел будет создан "в стороне", вместо того, чтобы быть привязанным к 
уже существующему узлу и/или сегменту. 

Общая для всего проекта величина порога прилипания устанавливается в ``Установки ‣ Параметры``. 

На вкладке Оцифровка можно установить режим прилипания по умолчанию: 

1. К вершинам. 
2. К сегментам. 
3. К вершинам и сегментам. 

Также можно определить значения по умолчанию для единиц измерения порога прилипания 
и радиуса поиска для редактирования вершин. Эти величины могут быть установлены 
как в единицах карты, так и в пикселах. 
Преимущество использования пикселов в качестве единиц заключается в том, что при 
зуммировании порог прилипания не будет изменяться.

Величина порога прилипания для отдельного слоя устанавливается в ``Установки ‣ Параметры прилипания...`` 
для включения и настройки режима и порога прилипания для каждого слоя (см. :numref:`ngqgis_adhesion`).

Обратите внимание, что величина порога прилипания для отдельного слоя имеет преимущество 
над общим порогом прилипания, установленным на вкладке "Оцифровка". Таким образом, 
если надо отредактировать один слой и прилепить его вершины к другому слою, необходимо 
активировать прилипание "прилипание к" для слоя, затем снизить общий порог прилипания 
для проекта до меньшего значения. Кроме того, прилипание невозможно для слоя, не 
активизированного в диалоговом окне параметров прилипания, независимо от параметров 
общего прилипания. Поэтому необходимо убедиться, что у слоя, к которому необходимо 
применить прилипание, стоит флажок.

.. figure:: _static/adhesion.png
   :name: ngqgis_adhesion
   :align: center
   :width: 16cm
 
   Окно Параметры прилипания.

.. note:: 
   Прилипание к сегментам работает, но как правило выдаёт точку, не находящуюся на сегменте. Это происходит из-за перепроецирования на лету, провисания линии и другой математики. Надёжнее будет, если вы будете прилипать только к вершинам (то есть получившиеся геометрии будут такими, как вы себе представляете). 
  
Топологическое редактирование
--------------

При этой настройке, если у вас есть в слое полигоны, то при рисовании новых полигонов, они будут не накладываться на старые, а соприкасаться. 


.. figure:: _static/topological_editing_map.png
   :name: ngqgis_topological_editing_map
   :align: center
   :width: 16cm
 
   Топологическое редактирование. Полигон, примыкающий к Москве.
   
Этот режим работает только при следующих настройках:

* ``Установки ‣ Параметры прилипания ‣ Включить топологическое редактирование``
* ``Установки ‣ Параметры прилипания ‣ Выбор слоя  ‣ Дополнительно  ‣ Избегать пересечений``
   
Копирование объектов
-------------------------------------

Выделенные объекты можно удалять, копировать и вставлять из слоя в слой одного 
проекта NextGIS QGIS при условии, что для них включен "Режим 
редактирования".

Объекты также можно вставить во внешние приложения в виде текста: объекты отражаются 
в формате :abbr:`CSV (Comma-Separated Values)`, где их геометрия передается форматом :abbr:`WKT (Well-Known Text)`.

Что случится, если исходный и целевой слой имеют разную структуру (названия полей 
и их типы отличаются)? NextGIS QGIS заполнит совпадающие поля и проигнорирует остальные. 
Если результат копирования атрибутов в целевой слой не имеет значения, то становится 
неважно, в каком виде они там будут представлены. Если в целевом слое необходимо 
сохранить все с точностью — объекты и их атрибуты, необходимо убедиться, что структуры 
исходного и целевого слоя совпадают.

.. note::
   **Соответствие вставляемых объектов**
   
   Если исходный и целевой слой находятся в одинаковой проекции, тогда геометрия 
   вставленных объектов будет идентична исходному слою. Однако если целевой слой 
   находится в проекции, отличной от исходной, тогда NextGIS QGIS не гарантирует 
   идентичность геометрии. Это происходит по причине незначительных ошибок округления, 
   неизбежных при переходе от одной проекции к другой.

Пространственное связывание 
--------------------------------------------------------------------------

Пространственное связывание осуществляется присоединение атрибутов по месторасположению.
Этот инструмент принимает 2 слоя, и создаёт новый слой.  Таким образом можно рассчитать:

* Количество автобусных остановок в каждом районе Минска.
* Сумму населения во всех городах, для каждого района Московской области.
* Средний охват ствола ели в сантиметрах в каждом лесном квартале заповедника.

Запуск осуществляется через processing: 
``Общие инструменты для работы с векторами ‣ Объединение атрибутов по районам``.
Инструменту объединения нужно задать 2 слоя. Первый (целевой) - тот, в который 
добавятся атрибуты из пересекающихся объектов второго слоя. 
Рассчёт числовых значений (среднее, медиана) может работать некорректно, если в 
списке зачений встречаются NULL. Попробуйте преобразовать такие значения в 0, используя калькулятор полей.
