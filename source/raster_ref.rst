.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _raster_ref:
    
Привязка растров
===================

С помощью данного модуля расширения пользователь QGIS получает возможность привязывать растры к координатам.

Для начала работу нужно включить модуль "Привязка растров (GDAL)" в списке модулей. 

После установки модуля появится пункт меню Растр ‣ Привязка растров.

Этот плагин предоставляет графический интерфейс, в котором пользователь указывает общие опорные точки (традиционно называются gcp, ground control points) на растре и на карте в основном окне NextGIS QGIS. Так же координаты опорных точек можно вводить цифрами с клавиатуры, если на карте есть координатная сетка, и пользователь представляет её код EPSG. Затем при расчёте генерируется новый файл в формате GeoTIFF, с информацией о привязке внутри. 

Примеры операций, которые можно сделать в этом модуле
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* Привязать советскую топокарту к слою openstreetmap
* Привязать топокарту с сеткой, введя её координаты с клавиатуры, это будет более точно, чем привязывать по точкам.
* Привязать 1-2 снимка поверхности с летательного аппарата по визуальным ориентирам.
* Допривязать полученный из другого софта ортофотоплан к точной карте. 
* Привязать сфотографированную распечатку карты OSM с отметками ручкой, что бы потом оцифровать эти отметки.
* Привязать древнюю карту из книги царских времён у которой нет сетки, или она в неизвестной системе координат.


Описание интерфейса
-----------------------

.. figure:: _static/ngqgis_privyazka_ru.png
   :name: ngqgis_privyazka_pic
   :align: center
   :width: 20cm
   
   Интерфейс модуля Привязка растров


Параметры трансформации
------------------------------

Задаются в диалоговом окне Параметры ‣ Параметры трансформации.

Тип трансформации
^^^^^^^^^^^^^^^^^^^^^^^

Это обозначает, каким алгоритмом будут перемещаться пикселы и растягиваться карта. Алгоритм выбирается в зависимости от комбинации проекций карт - ту в которой лежит растровая карта, и та к которой привязывается. 

Если вы не разбираетесь в проекциях, то выбирайте "Тонкостенный сплайн", этот алгоритм привяжет всё.

* Линейная - алгоритм делает только поворот, масштабирование, и skew. Этот алгоритм генерирует .world-файл, а все остальные алгоритмы генерируют новый GeoTIFF с привязкой внутри. Достаточно 3 точек. 
* Helmert - алгоритм делает только поворот, масштабирование, и skew. Он пригоден, если обе карты в одинаковой проекции. Например, если вы взяли карту openstreetmap, напечатали на принтере, нарисовали поверх неё ручкой новые объекты, и сфотографировали эту бумагу, то можете привязать её обратно к openstreetmap этим алгоритмом. Достаточно 3 точек.
* Полиномиальная 1-2-3 - используются для привязки бумажных карт. Чаще всего используется алгоритм Полиномиальная-2, который делает кривизну, например при привязке карт в проеции Гаусс-Крюгера к слою в Pseudo Mercator.  Полиномиальная-1 делает то, что так же назвается афинным преобразованием. Для этих алгоритмов требуется большее число опорных точек.
* Тонкостенный сплайн - современный алгоритм, который позволяет делать локальные деформации, то есть разные в разных местах карты. Он самый всеядный, пригоден для привязки всего, что можно открыть как растр.
* Проективная - работает как Helmert, но делает несколько больше геометрических операций. Пригоден для случая когда нужно привязать одиночное фото из летательного аппарата к карте.

Метод интерполяции
^^^^^^^^^^^^^^^^^^^^^^

Это обозначает алгоритм масштабирования изображения, все эти алгоритмы такие же, как в графических редакторах. Разница между ними в визуальном качестве изображения, и почти всегда незаметна, только чуть-чуть изменяется размытость. 

* Ближайший сосед - быстрый алгоритм. Подойдёт для случая, когда вы долго подбираете опорные точки для тонкостенного сплайна, и хотите быстро расчитать результат и посмотреть, какая получилась невязка в этот раз.
* Ланцоша - обычно все используют её, потому что этот алгоритм даёт стабильные результаты независимо от вида изображения.
* Линейная
* Кубическая
* Кубический сплайн

Сжатие
^^^^^^^^^^^^^

После привязк растр получается несжатый, и занимает много места на диске. Можно выбрать алгоритм Deflate, он сжимает растр, но ненамного. Поэтому после привязки вы можете запустить Растр ‣ Извлечение ‣ Обрезка, и обрезать растр по альфа-каналу, затем Растр ‣ Преобразование ‣ Преобразовать формат и сохранить его в GeoTIFF с сжатием JPEG. Это заметно уменьшит размер файлов.



Порядок действий для привязки карты
----------------------------------------------

1. Подготовить растровый файл с картой, которую вы будете привязывать. Если она в формате .gif, то сконвертируйте её в jpeg или png используя инструмент Растр ‣ Преобразование ‣ Преобразовать формат (см http://docs.nextgis.ru/docs_ngqgis/source/raster_op.html#id9) или любой графический редактор.

Если исходный файл большой, то он долго будет рисоваться на экране. В этом случае нажмите "Параметры ‣ Свойства растра ‣ Пирамиды", выделите там в списке все строки, "тип - внешние", и нажмите "Создать пирамиды". Получится отдельный файлик с уменьшенными копиями растра, который будет использоваться автоматически для более быстрой отрисовки.

2. Открыть в QGIS карту, к которой вы будете привязывать растр. 
3. Решить, в какой системе координат нужна конечная карта. 
4. Запустить модуль привязки растров: Растр ‣ Привязка растров. Далее описываются команды модуля Привязка Растров.

5. Нажать Файл ‣ Открыть растр. Открываете вашу картинку. 

.. figure:: _static/georef_open_raster_ru.png
   :name: georef_open_raster_pic
   :align: center
   :width: 20cm
   
   Открытие растра

6. Добавить точки. Нажмите кнопку |button_georef_add_point| на панели инструментов или выберите Правка ‣ Добавить точку. 

.. |button_georef_add_point| image:: _static/button_georef_add_point.png

.. figure:: _static/georef_select_add_point_ru.png
   :name: georef_select_add_point_pic
   :align: center
   :width: 20cm
   
   Выбор команды "Добавить точку"

Поставьте точку на карту. Появится окно с полями ввода координат.

.. figure:: _static/georef_coord_from_map_ru.png
   :name: georef_coord_from_map_pic
   :align: center
   :width: 20cm
   
   Окно ввода координат при добавлении точки. Кружком отмечена добавляемая точка

Нажмите кнопку **С карты**. Откроется основное окно QGIS, поставьте точку на это же место на карту.

.. figure:: _static/georef_select_on_map_ru.png
   :name: georef_select_on_map_pic
   :align: center
   :width: 20cm
   
   Выбор соответствующей точки на карте
   
.. figure:: _static/georef_coord_result_ru.png
   :name: georef_coord_result_pic
   :align: center
   :width: 12cm
   
   Полученные с карты координаты точки

Нажмите **Ок** для завершения добавления точки.

Поставьте так для начала 3 точки. Минимально необходимое количество точек зависит от алгоритма, если их будет недостаточно, то вам выведется сообщение.

Точки можно сохранить на диск, на случай сбоев, командой "Файл ‣ Сохранить контрольные точки как". Сохраните их в путь по умолчанию, и они будут подтягиваться автоматически при следующем запуске модуля Привязки растров. 


7. Проверить параметры трансформации, открыв "Параметры ‣ Параметры трансформации". Там можно указать путь для нового файла (по умолчанию - исходная папка), выбрать тип трансформации и метод интерполяции, целевую систему координат. 

8. Запустить привязку растра, нажав кнопку с зеленой стрелкой |button_start_georef| на панели инструментов или "Файл ‣ Начать привязку растра".

.. |button_start_georef| image:: _static/button_start_georef.png

9. Добавить трансформированный растр как новый слой. Чтобы готовый растр сразу открылся в окне QGIS, поставьте флажок **Открыть в QGIS** в параметрах трансформации.

Вы можете проанализировать невязки визуально, покрутив настройки прозрачности (например для сравнения ортофотопланов и спутниковых снимков подходит режим смешивания "Направленный свет").

.. figure:: _static/georef_result_ru.png
   :name: georef_result_pic
   :align: center
   :width: 14cm
   
   Результат привязки растра



Здесь был описан процесс привязки карт по точкам. Так же можно привязвать карты по числовым координатам, см. http://docs.nextgis.ru/docs_howto/source/topo_georef.html

.. info::

   Описание утилиты gdaltransform, которая выполняет расчёты внутри этого модуля: https://www.gdal.org/gdaltransform.html
